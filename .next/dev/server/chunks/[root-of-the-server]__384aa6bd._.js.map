{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Portal%20All%20Clean%20Masters/CleanMasters2/lib/prisma.ts"],"sourcesContent":["// ============================================\n// LIB/PRISMA.TS\n// ============================================\n// ðŸ†• NUEVO - Copiar a: CleanMasters2/lib/prisma.ts\n\nimport { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\n  })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA,+CAA+C;AAC/C,gBAAgB;AAChB,+CAA+C;AAC/C,mDAAmD;AAEnD;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///C:/Portal%20All%20Clean%20Masters/CleanMasters2/app/api/appointments/route.ts"],"sourcesContent":["// ============================================\n// APP/API/APPOINTMENTS/ROUTE.TS\n// ============================================\n// ðŸ”„ REEMPLAZAR - Backup primero el existente\n// UbicaciÃ³n: CleanMasters2/app/api/appointments/route.ts\n\nimport { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { shouldBeLocked } from '@/lib/time-utils'\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = req.nextUrl\n    const date = searchParams.get('date')\n    const crewId = searchParams.get('crewId')\n    const clientId = searchParams.get('clientId')\n    const status = searchParams.get('status')\n\n    const where: any = {}\n    \n    if (date) {\n      const targetDate = new Date(date)\n      where.scheduledDate = {\n        gte: new Date(targetDate.setHours(0, 0, 0, 0)),\n        lt: new Date(targetDate.setHours(23, 59, 59, 999))\n      }\n    }\n    \n    if (crewId) where.crewId = crewId\n    if (clientId) where.clientId = clientId\n    if (status) where.status = status\n\n    const appointments = await prisma.appointment.findMany({\n      where,\n      include: {\n        client: true,\n        crew: {\n          include: {\n            members: true\n          }\n        },\n        evidence: true,\n        history: {\n          orderBy: { timestamp: 'desc' },\n          take: 10\n        }\n      },\n      orderBy: [\n        { scheduledDate: 'asc' },\n        { startTime: 'asc' }\n      ]\n    })\n\n    // Auto-lock check\n    const now = new Date()\n    const updates: Promise<any>[] = []\n    \n    appointments.forEach(apt => {\n      if (!apt.isLocked && shouldBeLocked(apt.scheduledDate, apt.startTime, now)) {\n        updates.push(\n          prisma.appointment.update({\n            where: { id: apt.id },\n            data: { \n              isLocked: true,\n              lockedAt: now,\n              status: apt.status === 'SCHEDULED' ? 'IN_PROGRESS' : apt.status\n            }\n          })\n        )\n      }\n    })\n\n    if (updates.length > 0) {\n      await Promise.all(updates)\n    }\n\n    return NextResponse.json(appointments)\n  } catch (error) {\n    console.error('GET appointments error:', error)\n    return NextResponse.json({ error: 'Failed to fetch appointments' }, { status: 500 })\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json()\n\n    if (!body.clientId || !body.scheduledDate || !body.startTime || !body.durationMinutes) {\n      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 })\n    }\n\n    const [hours, minutes] = body.startTime.split(':').map(Number)\n    const totalMinutes = hours * 60 + minutes + body.durationMinutes\n    const endHours = Math.floor(totalMinutes / 60)\n    const endMinutes = totalMinutes % 60\n    const endTime = `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`\n\n    let address = body.address\n    let city = body.city\n    let zone = body.zone\n\n    if (!address || !zone) {\n      const client = await prisma.client.findUnique({\n        where: { id: body.clientId }\n      })\n\n      if (client) {\n        address = address || client.address || 'No address'\n        city = city || client.city\n        zone = zone || client.zone\n      }\n    }\n\n    const appointment = await prisma.appointment.create({\n      data: {\n        clientId: body.clientId,\n        crewId: body.crewId || null,\n        scheduledDate: new Date(body.scheduledDate),\n        startTime: body.startTime,\n        endTime,\n        durationMinutes: body.durationMinutes,\n        address,\n        city,\n        zone,\n        status: 'SCHEDULED',\n        isLocked: false,\n        serviceType: body.serviceType,\n        tasks: body.tasks || [],\n        specialNotes: body.specialNotes,\n        estimatedCost: body.estimatedCost\n      },\n      include: {\n        client: true,\n        crew: {\n          include: {\n            members: true\n          }\n        }\n      }\n    })\n\n    await prisma.appointmentHistory.create({\n      data: {\n        appointmentId: appointment.id,\n        action: 'created',\n        newValue: 'SCHEDULED',\n        performedBy: 'System',\n        notes: 'Appointment created'\n      }\n    })\n\n    return NextResponse.json(appointment, { status: 201 })\n  } catch (error) {\n    console.error('POST appointment error:', error)\n    return NextResponse.json({ error: 'Failed to create appointment' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}